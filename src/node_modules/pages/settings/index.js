import React, {useState, useEffect, useContext} from 'react'
import {Redirect} from 'react-router-dom'
import useFetch from 'hooks/useFetch'
import {CurrentUserContext} from 'contexts/currentUser'

const Settings = () => {
  const apiUrl = `/user`
  const [name, setName] = useState('')
  const [image, setImage] = useState('')
  const [bio, setBio] = useState('')
  const [email, setEmail] = useState('')
  const [password, setPassword] = useState('')
  const [isSuccess, setIsSuccess] = useState(false)
  const [userState, dispatch] = useContext(CurrentUserContext)
  const [{ response, error }, doFetch] = useFetch(apiUrl)

  const submitHandler = e => {
    e.preventDefault()
    doFetch({
        method: 'put',
        data: {
            user: {
                ...userState.currentUser, username: name, image, bio, email, password
            }
        }
    })
  }

  useEffect(() => {
      if(!userState.currentUser) {
          return false
      }
      const user= userState.currentUser
      setName(user.username)
      setEmail(user.email)
      setImage(user.image)
      setBio(user.bio)

  }
  ,[userState.currentUser])

  useEffect(() => {
    if(!response) {
        return false
    }
    setIsSuccess(true)
  },[response])

  if(isSuccess) {
      return <Redirect to='/' />
  }
  return (
    <div className="article-container">
            <form onSubmit={submitHandler}>
                <ul className="article-table">
                    <li className="article-row"><h2>Your Settings</h2></li>
                    <li className="article-row">
                        <input type="text" className="w-100" value={name} onChange={e=>setName(e.target.value)} name="name" placeholder="Enter User name"/>
                    </li>
                    <li className="article-row">
                        <input type="text" className="w-100" value={image} onChange={e=>setImage(e.target.value)} name="image" placeholder="Image of Profile"/>
                    </li>
                    <li className="article-row">
                        <textarea name="bio" className="w-100-no-h" defaultValue={bio} onChange={e=>setBio(e.target.value)} cols="20" rows="10" placeholder="Write about your Bio (in markdown)"></textarea>
                    </li>
                    <li className="article-row">
                        <input type="text" value={email} onChange={e=>setEmail(e.target.value)} className="w-100" name="email" placeholder="Email"/>
                    </li>
                    <li className="article-row">
                        <input type="password" value={password} onChange={e=>setPassword(e.target.value)} className="w-100" name="password" placeholder="New Password"/>
                    </li>
                    <li className="article-row">
                        <button onChange={submitHandler}>Update Settings</button>
                    </li>
                </ul>
            </form>
      </div>
  )
}

export default Settings
